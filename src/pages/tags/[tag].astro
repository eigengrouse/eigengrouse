---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  const publishedPosts = allPosts.filter((post) => !post.data.draft);

  const uniqueTags = Array.from(
    new Set(publishedPosts.flatMap((post) => post.data.tags ?? []))
  );

  return uniqueTags.map((tag) => {
    const filteredPosts = publishedPosts
      .filter((post) => post.data.tags?.includes(tag))
      .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const title = tag
  .split('-')
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ');

// only keep tags that can actually change the results (not present on every post)
const totalPosts = posts.length;
const tagCounts = new Map();

for (const post of posts) {
  for (const t of post.data.tags ?? []) {
    if (t === tag) continue; // exclude current tag
    tagCounts.set(t, (tagCounts.get(t) ?? 0) + 1);
  }
}

// “meaningful” tags appear in SOME posts but NOT ALL posts
const effectiveTags = Array.from(tagCounts.entries())
  .filter(([, count]) => count > 0 && count < totalPosts)
  .map(([t]) => t)
  .sort();
---

<BaseLayout title={title}>
  <div class="posts">
    <h1 class="posts-title">{title}</h1>

    {effectiveTags.length > 0 && (
    <div>
      {effectiveTags.map((t) => (
        <label style="cursor:pointer;margin-top:10px">
          <input type="checkbox" value={t} class="tag" />
          <span>#{t}&nbsp;</span>
        </label>
      ))}
    </div>
    )}

    {posts.length === 0 ? (
      <p>No posts yet. Check back soon!</p>
    ) : (
      <div class="posts-grid" id="results">
        {posts.map((post) => (
          <div class="post-item" data-tags={(post.data.tags ?? []).join(',')}>
            <PostCard post={post} />
          </div>
        ))}
      </div>
    )}
  </div>

  <script>
    const tagEls = [...document.querySelectorAll("input.tag")];
    const items = [...document.querySelectorAll("#results .post-item")];

    function getSelectedTags() {
      return tagEls.filter((x) => x.checked).map((x) => x.value);
    }

    function apply() {
      const selected = getSelectedTags();

      items.forEach((el) => {
        const tags = (el.dataset.tags || "").split(",").filter(Boolean);
        const matches =
          selected.length === 0
            ? true
            : selected.every((t) => tags.includes(t)) // AND
        el.style.display = matches ? "" : "none";
      });

      // Keep filter state in URL (?tags=a,b&mode=all)
      const url = new URL(window.location.href);
      if (selected.length)
        url.searchParams.set("and", selected.join(","));
      else
        url.searchParams.delete("and");

      history.replaceState(null, "", url);
    }

    // Restore state from URL on load
    const url = new URL(window.location.href);
    const tags = (url.searchParams.get("and") || "").split(",").filter(Boolean);
    tagEls.forEach((cb) => (cb.checked = tags.includes(cb.value)));
    tagEls.forEach((cb) => cb.addEventListener("change", apply));
    apply();
  </script>
</BaseLayout>
